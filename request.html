<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="nav.css">
	<link rel="stylesheet" type="text/css" href="convention.css">
</head>
<style>
	#prog{
		-webkit-appearance: none;
		appearance: none;
	}
</style>
<body>
	<ul class="nav">
		<li class="logo"><a href="index.html">MANGOSUB</a></li>
		<li><a style="display: block; width: 77px;" id="bcredits">$100</a></li>
		<li><a href="" class="hov" >LOGOUT</a></li>
		<li><a href="profile.html" class="hov">PROFILE</a></li>
		<li><a href="generate_info.html" class="hov">WORK</a></li>
		<li><a href="request.html" class="hov active">REQUEST</a></li>
		<li><a href="index.html" class="hov">ABOUT</a></li>
	</ul>
	<div style="margin-top: 70px; overflow: auto; height: calc(100vh - 70px);">
		<div style = "margin-top: 100px; margin-left: 200px;">
			<p style = "height: 70px; width: 600px"><font size = "6">To request subtitles for a video press Browse, select the file and Submit</font></p>
			<p style = "height: 50px;"><font size = "5">P.S. File size must not exceed 300MB</font></p>
			<label>
				<progress value="0" max="100" id = "prog">0%</progress>
				<input type="file" accept="video/*" class = "fileupload" id="fileupload"> 
			</label> 
			<button id = "submitbtn" style="width: auto;">SUBMIT</button>
	    </div>
	</div>


	<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
	<script>
	  // Initialize Firebase
	    var config = {
	       apiKey: "AIzaSyDeunaXdZRX8Kc960GDhzik2bpNKwN2lDY",
	       authDomain: "mangosub-kaist.firebaseapp.com",
	   	   databaseURL: "https://mangosub-kaist.firebaseio.com",
	  	   projectId: "mangosub-kaist",
	   	   storageBucket: "mangosub-kaist.appspot.com",
	   	   messagingSenderId: "753510490577"
	    };
	    firebase.initializeApp(config);

	    var prog = document.getElementById('prog');
	    var fileupload = document.getElementById('fileupload');
	    var submitbtn = document.getElementById('submitbtn');

		//listen for file selection
		fileupload.addEventListener('change', function(e){
			var file = e.target.files[0];
			var storageRef = firebase.storage().ref('/videos/' + file.name);
			var task = storageRef.put(file);
			var percentage = 0

			submitbtn.addEventListener('click', function(){
				task.pause();
				if (percentage < 100){
					if (confirm('You have not uploaded your video yet. Do you want to continue?')){
						task.resume();
					}
					else{
						task.cancel();
						location.href = 'request.html';
					}
				}
				else{
					location.href = 'index.html';
				}
			});
			//Update progress bar
			task.on('state_changed',
				function(snapshot){
					percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
					prog.value = percentage;
				},
				function(error){

				},

				function(){
					firebase.auth().onAuthStateChanged(function(user) {
						if (user) {
							var uid = user.uid;
							var path = firebase.database().ref('subtitles/').push();
							var downloadURL = task.snapshot.downloadURL;
							path.set({
								requested_time: firebase.database.ServerValue.TIMESTAMP,
								requested_user: uid,
								video_title: file.name,
								video_url: downloadURL,
								done: 0
							});
						} else {

						}
					});
				}
			);
		});
	</script>
</body>
</html>
