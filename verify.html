<!DOCTYPE html>
<html>
<head>
	<title>Verify</title>
	<link rel="stylesheet" href="working.css">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="nav.css">
	<link rel="stylesheet" type="text/css" href="convention.css">
	<link rel="stylesheet" type="text/css" href="instructions.css">
	<link rel = "stylesheet" type = "text/css" href = "media-player.css">
	<script type="text/javascript" src = "input_to_sub.js"></script>
	<script type ="text/javascript" src="jquery.js"></script>
  	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  	<script type="text/javascript" src = "functions.js"></script>
  	<script type="text/javascript" src="setBoundingClientRect.js"></script>
  	<script type="text/javascript" src="media-player.js"></script>
</head>
<body>
	<ul class="nav">
		<li class="logo"><a href="index.html">MANGOSUB</a></li>
		<li><a style="display: block; width: 77px;" id="bcredits"></a></li>
		<li><a href="" class="hov" >LOGOUT</a></li>
		<li><a href="profile.html" class="hov">PROFILE</a></li>
		<li><a href="generate_info.html" class="hov active">WORK</a></li>
		<li><a href="request.html" class="hov">REQUEST</a></li>
		<li><a href="index.html" class="hov">ABOUT</a></li>
	</ul>
	<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyDeunaXdZRX8Kc960GDhzik2bpNKwN2lDY",
			authDomain: "mangosub-kaist.firebaseapp.com",
			databaseURL: "https://mangosub-kaist.firebaseio.com",
			projectId: "mangosub-kaist",
			storageBucket: "mangosub-kaist.appspot.com",
			messagingSenderId: "753510490577"
		};
		firebase.initializeApp(config);
		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				// User is signed in.
				var displayName = user.displayName;
				var email = user.email;
				var uid = user.uid;

				var db = firebase.database().ref().child("users").child(uid);

				db.child("credits").once("value").then(function(snapshot) {
					var credits_val = snapshot.val();
					document.getElementById("bcredits").innerHTML = "â‚¡ " + String(credits_val);
				});
			} else {
				// User is signed out.
				window.location = "index.html";
			}
		});
	</script>
	<style>
		form {
		    border: 3px solid #f1f1f1;
		}
		.submitbtn{
		  background-color: #f44336;
		  color: white;
		  padding: 14px 20px;
		  margin: 8px 0;
		  border: none;
		  cursor: pointer;
		  width: 300px;
		}
		button:hover {
		    opacity: 0.8;
		}
		.congrats{
		  font:25;
		}
		.workmorebtn{
		  background-color: #f44336;
		  color: white;
		  padding: 14px 20px;
		  margin: 8px 0;
		  border: none;
		  cursor: pointer;
		  width: 150px;
		}
		.homebtn{
		  background-color: #f44336;
		  color: white;
		  padding: 14px 20px;
		  margin: 8px 0;
		  border: none;
		  cursor: pointer;
		  width: 150px;
		}
		.facebookbtn {
		    color: white;
		    padding: 14px 20px;
		    margin: 8px 0;
		    border: none;
		    cursor: pointer;
		    width: auto;
		    background-color: #3b5998;
		    width: 100px;
		}
		.naverbtn {
		    color: white;
		    padding: 14px 20px;
		    margin: 8px 0;
		    border: none;
		    cursor: pointer;
		    width: auto;
		    background-color: #3EAF0E;
		    width: 100px;
		}
		.container {
		    padding: 16px;
		}
		/* The Modal (background) */
		.modal {
		    display: none; /* Hidden by default */
		    position: fixed; /* Stay in place */
		    z-index: 1; /* Sit on top */
		    left: 0;
		    top: 0;
		    width: 100%; /* Full width */
		    height: 100%; /* Full height */
		    overflow: auto; /* Enable scroll if needed */
		    background-color: rgb(0,0,0); /* Fallback color */
		    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		    padding-top: 60px;
		}
		/* Modal Content/Box */
		.modal-content {
		    background-color: #fefefe;
		    margin: 5% auto 15% auto; /* 5% from the top, 15% from the bottom and centered */
		    border: 1px solid #888;
		    width: 350px; /* Could be more or less, depending on screen size */
		    text-align: center;
		}
		/* The Close Button (x) */
		.close {
		    position: absolute;
		    right: 25px;
		    top: 0;
		    color: #000;
		    font-size: 35px;
		    font-weight: bold;
		}
		.close:hover,
		.close:focus {
		    color: red;
		    cursor: pointer;
		}
		/* Add Zoom Animation */
		.animate {
		    -webkit-animation: animatezoom 0.6s;
		    animation: animatezoom 0.6s
		}
		@-webkit-keyframes animatezoom {
		    from {-webkit-transform: scale(0)} 
		    to {-webkit-transform: scale(1)}
		}

		@keyframes animatezoom {
		    from {transform: scale(0)} 
		    to {transform: scale(1)}
		}
	</style>
	
	<div style="margin-top: 70px; overflow: auto; height: calc(100vh - 70px);">
<div class = "type_div">
	<div class="video_div">
		<div id="slider-range"></div>
		<h1 class="header_name" id = "video_title"></h1>

		<div class="video_sub" >
			<video id="video_player" class = "video_style" controls>
				<source id="video_src" src="" type="video/mp4">
				Your browser does not support the video tag.
			</video>
			<h1 class="sub_text" style="color: white" id = "sub_text_generate">Loading video...</h1>
		</div>
		<div class="video_controls">

			
			<div id='media-controls' >
				<div id="other_controls" style="padding-bottom: 10px">
					<img src="images/play.png" id='play-pause-button' class='play' title='play' onclick='togglePlayPause();'>
					<img src="images/volume+.png" id='volume-inc-button' class='volume-plus' title='Increase volume' onclick='changeVolume("+");'>
					<img src="images/volume-.png" id='volume-dec-button' class='volume-minus' title='Decrease volume' onclick='changeVolume("-");'>
				</div>
				<div id="done_and_progress">
					<div id="progressed_bar" title="Already generated portions."></div>
					<progress id='progress-bar' min='0' max='100' value='0' title="Progress bar">0% played</progress>
				</div>
				


			</div>
		</div>
		
		<div class="slider">
			  	
			<img class = "slider_image" id="start_slider" src="images/start.png">
			<img class = "slider_image" id="end_slider" src="images/end.png">
		</div>
		<div>
			<h1 style="font-size: 12px; position: relative; margin-left: 25px">Select the most correct line that corresponds to the videos section.</h1>
		</div>
		<div class="sub_show">
			<input type="text" style = "width: 60%"  class="sub_text_input" id="sub_text_input_generate_1" readonly value="">
			<img id="tick_1" src="images/check_unselected.png" style= 'width : 30px; height: 30px; margin-left: 25px' onclick='select_subs("1")'></img>
		</div>

		<div class="sub_show">
			<input type="text"  style = "width: 60%" class="sub_text_input" id="sub_text_input_generate_2" readonly value="">
			<img id="tick_2" src="images/check_unselected.png" style= 'width : 30px; height: 30px; margin-left: 25px' onclick='select_subs("2")'></img>
		</div>

		<div class="sub_show">
			<input type="text" style = "width: 60%" class="sub_text_input" id="sub_text_input_generate_3" readonly value = "">
			<img id="tick_3" src="images/check_unselected.png" style= 'width : 30px; height: 30px; margin-left: 25px' onclick='select_subs("3")'></img>
		</div>
		<div class = "div_buttons">
			<a href="index.html"><button style="margin-right: 50px; width: auto;">Home</button></a>
			<a ><button style="margin-left: 50px; width: auto;" id  = "SubmitBtn">Submit</button></a>
		</div>
		<div id = "id01" class = "modal">
		  <form class="modal-content animate" action="http://mangosub.com/profile_page">
		    <div class = "container" style = "text-align: center">
		      <p><font size = "5">Congratulations!</font></p>
		      <p><font size = "5">You earned +2 credits!</font></p>
		      <button onclick="random_work()" type = "button" class = "workmorebtn">Work more</button>
		      <button onclick="location.href='index.html'" type = "button" class = "homebtn">Home</button>
		    </div>

		    <div class = "container" style = "background-color:#f1f1f1; text-align: center">
		      <p><font size = "5">Share your results</font></p>
		      <button type = "button" onclick="location.href='http://www.facebook.com'" class = "facebookbtn">Facebook</button>
		      <button type = "button" onclick="location.href='http://www.naver.com'" class = "naverbtn">Naver</button>
		    </div>
		  </form>
		</div>
		<script>
		    var found = false;
		    var isAllDone = true;
		    var generated = "-1";
		    var fix_1 = "-2";
		    var fix_2 = "-3";
		    var choice = -1;
		    var DBref = firebase.database().ref().child("subtitles");
			DBref.orderByChild("done").once("value").then(function(snapshot){
				snapshot.forEach(function(video){
					if (video.val().done === 2){
						var vid_id = video.key;
						var sub_times = DBref.child(vid_id).child("sub_times");
						sub_times.orderByChild("verified").once("value").then(function(intervals){
							intervals.forEach(function(interval){
								console.log(interval.val().verified);
								if (interval.val().verified == null && interval.val().fixed == 2){
									found = true;
									var interval_id = interval.key;

									generated = interval.val().generated;
									fix_1 = interval.val().fix_1;
									fix_2 = interval.val().fix_2;

									var choice1 = document.getElementById('sub_text_input_generate_1');
									var choice2 = document.getElementById('sub_text_input_generate_2');
									var choice3 = document.getElementById('sub_text_input_generate_3');
									choice1.value = generated;
									choice2.value = fix_1;
									choice3.value = fix_2;

									var vid_url = DBref.child(vid_id).child("video_url");
									vid_url.once('value').then(function(snapshot){
										var path = snapshot.val();
										var pathStorage = firebase.storage().refFromURL(path);
										pathStorage.getDownloadURL().then(function(url){
											var sub = document.getElementById('sub_text_generate');
											sub.innerHTML = "";
											sub.style.color = 'white';
											var vid = document.getElementById("video_player");
											vid.src = url;
											var video_title = document.getElementById("video_title");
											var title_ref = firebase.database().ref().child("subtitles").child(vid_id).child("video_title");
											title_ref.once("value").then(function(snap){
												video_title.value = snap.val();
											});
											loaded = true;
											load_subtitles();
										})
									})
									var sbmt = document.getElementById("SubmitBtn");
									sbmt.addEventListener('click', function(){
										choice = getTicked();
										//console.log(choice);
										if(choice.localeCompare("-1")){
											document.getElementById('id01').style.display='block';
											// Save the final answer and give coins to the user
											var final_sub = "-1";
											var choiceInt = parseInt(choice);
											if (choiceInt === 1) final_sub = generated;
											if (choiceInt === 2) final_sub = fix_1;
											if (choiceInt === 3) final_sub = fix_2;
											var s_time = interval.val().s_time;
											var e_time = interval.val().e_time;
											console.log(s_time);
											console.log(e_time);

											var whereToStore = firebase.database().ref().child("subtitles").child(vid_id).child("sub_times").child(interval_id);
											whereToStore.set({
												s_time: s_time,
												e_time: e_time,
												generated: generated,
												fix_1: fix_1,
												fix_2: fix_2,
												fixed: 2,
												final_sub: final_sub,
												verified: 1
											});

											var uid = firebase.auth().currentUser.uid;
											var userpath = firebase.database().ref("/users/" + uid + "/events/").push();
											userpath.set({
												time: firebase.database.ServerValue.TIMESTAMP,
												type: "work",
												description: "You received 2 credits for completing a VERIFY task.",
												credits: 2
											});
											var db = firebase.database().ref().child("users").child(uid);
											db.child("credits").once("value").then(function(snapshot) {
												var credits_val = snapshot.val();
												firebase.database().ref("/users/" + uid).update({"credits": credits_val + 2});
											});
										}
										else{
											alert("You have not chosen anything yet");
										}
									});
									return true; // not sure whether it will work
								}
								else{
									var requested_time = video.val().requested_time;
									var requested_user = video.val().requested_user;
									var vid_title = video.val().video_title;
									var vid_url = video.val().video_url;

									firebase.database().ref().child("subtitles").child(vid_id).once("value").then(function(snapshot){
										var isDone = snapshot.val();
										firebase.database().ref("/subtitles/" + vid_id).update({"done" : 3});
									});
									return true;
									// set done to 3
								}
							})
						})
						if (found) return true;
					}
				})
			});
			//if (!found) alert("There is no video to be verified. Check back later");
		</script>
	</div>
		<script>
		  var modal = document.getElementById('id01');
		  // When the user clicks anywhere outside of the modal, close it
		  window.onclick = function(event) {
		      if (event.target == modal) {
			  	window.location.href = 'index.html';
		      }
		  }
		</script>
	</div>
</div></body>
</html>
